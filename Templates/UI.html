<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doc Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-6">
      <h1 class="text-2xl font-bold mb-6">üìÑ Doc Analyzer</h1>
      <nav class="space-y-4">
        <button class="w-full text-left font-medium hover:text-blue-600">Upload</button>
        <button class="w-full text-left font-medium hover:text-blue-600">View Meetstaat</button>
        <button class="w-full text-left font-medium hover:text-blue-600">Compare Sections</button>
        <button class="w-full text-left font-medium hover:text-blue-600">Discrepancies</button>
        <button class="w-full text-left font-medium hover:text-blue-600">Export Report</button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-10 overflow-auto">
      <div class="bg-white rounded-2xl shadow p-8">
        <h2 class="text-xl font-semibold mb-4">Upload Documents</h2>
        <form id="upload-form" class="space-y-4">
          <div>
            <label for="meetstaat-input" class="block text-sm font-medium text-gray-700">Meetstaat (CSV)</label>
            <input type="file" id="meetstaat-input" name="meetstaat" accept=".csv" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </div>
          <div>
            <label for="lastenboek-input" class="block text-sm font-medium text-gray-700">Lastenboek (PDF)</label>
            <input type="file" id="lastenboek-input" name="lastenboek" accept=".pdf" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </div>
          <button type="button" id="analyze-button" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50">Analyze</button>
        </form>
      </div>

      <!-- Placeholder for results -->
      <div class="mt-10">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Analysis Results</h2>
          <div> <!-- Container for buttons -->
            <!-- Discrepancy Analysis Button - Initially Hidden -->
            <button id="discrepancy-button" class="hidden bg-yellow-500 text-white px-4 py-2 rounded text-sm hover:bg-yellow-600 mr-2 disabled:opacity-50">Analyze Discrepancies</button>
            <!-- Export Button - Initially Hidden -->
            <button id="export-button" class="hidden bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">Export JSON</button>
          </div>
        </div>
        <div id="results-area" class="bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 min-h-[100px]">
          <p class="text-gray-500 italic">Initial results will appear here...</p>
        </div>
      </div>

      <!-- Placeholder for Discrepancy Analysis Results -->
      <div class="mt-10">
        <h2 class="text-xl font-semibold mb-4">Discrepancy Analysis</h2>
        <div id="discrepancy-results-area" class="hidden bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 min-h-[100px]">
          <p class="text-gray-500 italic">Click 'Analyze Discrepancies' above to start...</p>
        </div>
      </div>

    </main>
  </div>

  <!-- Add JavaScript block -->
  <script>
    const form = document.getElementById('upload-form');
    const meetstaatInput = document.getElementById('meetstaat-input');
    const lastenboekInput = document.getElementById('lastenboek-input');
    const analyzeButton = document.getElementById('analyze-button');
    const resultsArea = document.getElementById('results-area');
    const exportButton = document.getElementById('export-button');
    const discrepancyButton = document.getElementById('discrepancy-button');
    const discrepancyResultsArea = document.getElementById('discrepancy-results-area');

    analyzeButton.addEventListener('click', async () => {
      // Get the files
      const meetstaatFile = meetstaatInput.files[0];
      const lastenboekFile = lastenboekInput.files[0];

      // Basic validation
      if (!lastenboekFile) {
        alert('Please select a Lastenboek (PDF) file.');
        return;
      }
      // You might want to add validation for meetstaat if it becomes mandatory

      // Prepare form data to send
      const formData = new FormData();
      if (meetstaatFile) {
        formData.append('meetstaat', meetstaatFile);
      }
      formData.append('lastenboek', lastenboekFile);

      // Show loading state
      resultsArea.innerHTML = '<p class="text-blue-600 font-semibold">Analyzing documents... Please wait.</p>';
      analyzeButton.disabled = true;
      analyzeButton.textContent = 'Analyzing...';

      try {
        // Send data to the backend /analyze endpoint
        const response = await fetch('/analyze', {
          method: 'POST', // Use POST to send file data
          body: formData, // Send FormData directly
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Get the JSON result from the backend
        const result = await response.json();

        // Check for backend errors first
        if (result.error) {
          exportButton.classList.add('hidden');
          discrepancyButton.classList.add('hidden');
          discrepancyResultsArea.classList.add('hidden');
          throw new Error(`Backend error: ${result.error}`);
        }

        // --- Process and Display Initial Results ---
        let initialHtml = `
          <h3 class="font-semibold mb-2">Backend Message:</h3>
          <p class="mb-4">${result.message || 'Processing complete.'}</p>
        `;

        // Display Summary if available
        if (result.analysis_summary) {
            const summary = result.analysis_summary;
            initialHtml += `
                <h3 class="font-semibold mb-2 mt-4">Summary Counts:</h3>
                <p class="text-sm mb-4 border-b pb-4">
                    <span class="mr-4"><strong class="font-medium">In Both:</strong> ${summary.count_both || 0}</span>
                    <span class="mr-4"><strong class="font-medium">Only Meetstaat:</strong> ${summary.count_meetstaat_only || 0}</span>
                    <span><strong class="font-medium">Only Lastenboek:</strong> ${summary.count_lastenboek_only || 0}</span>
                </p>
            `;
        }

        // Display Processing Errors if any
        if (result.errors && result.errors.length > 0) {
          initialHtml += `
            <h3 class="font-semibold mb-2 text-red-600">Processing Errors:</h3>
            <ul class="list-disc list-inside mb-4 text-red-500">
              ${result.errors.map(e => `<li>${e}</li>`).join('')}
            </ul>
          `;
        }

        // Display Files Processed
        initialHtml += `
          <h3 class="font-semibold mb-2">Files Processed:</h3>
          <ul class="list-disc list-inside mb-4">
            <li>Meetstaat: ${result.meetstaat_filename}</li>
            <li>Lastenboek: ${result.lastenboek_filename}</li>
          </ul>
        `;

        // Filter the combined data
        const combinedData = result.analysis_output || [];
        const foundInBoth = combinedData.filter(item => item.meetstaat_present && item.lastenboek_toc_entry_present);
        const onlyInTOC = combinedData.filter(item => !item.meetstaat_present && item.lastenboek_toc_entry_present);
        const onlyInMeetstaat = combinedData.filter(item => item.meetstaat_present && !item.lastenboek_toc_entry_present);

        // Update the results area with initial info + summary
        resultsArea.innerHTML = initialHtml;

        // Helper function to generate item list HTML
        const generateItemListHtml = (items, title) => {
          let listHtml = `<h3 class="font-semibold mb-2 mt-4">${title} (${items.length} items):</h3>`;
          if (items.length === 0) {
            listHtml += '<p class="text-sm text-gray-500 italic">None</p>';
            return listHtml;
          }
          listHtml += '<div class="space-y-3 text-sm max-h-96 overflow-y-auto border rounded p-3 bg-gray-100">'; // Increased max-height
          items.forEach(item => {
            const code = item.item_code;
            const meetstaatInfo = item.meetstaat_info;
            const lastenboekInfo = item.lastenboek_page_range;
            const comparisonResult = item.comparison_result || 'Pending'; // Use comparison_result key

            // --- Build Meetstaat Details String --- 
            let meetstaatDetailsHtml = '';
            if (item.meetstaat_present && meetstaatInfo) {
              const description = meetstaatInfo.Description || 'N/A';
              const quantity = meetstaatInfo.Quantity !== undefined && meetstaatInfo.Quantity !== null ? meetstaatInfo.Quantity : 'N/A'; // Handle potential null/undefined
              const unit = meetstaatInfo.Unit || ''; // Empty string if no unit
              const type = meetstaatInfo.Type || ''; // Contains expanded text like "Vermoedelijke Hoeveelheid (VH)"
              const notes = meetstaatInfo.Notes || ''; // Contains expanded text or original like HVAC
              
              meetstaatDetailsHtml = `
                <p><strong class="font-medium text-gray-700">Meetstaat:</strong> ${description}</p>
                <p class="text-xs ml-4 text-gray-600">
                  Hoeveelheid: ${quantity} ${unit} (${type}) ${notes ? `- ${notes}` : ''}
                </p>
              `;
            }
            // --- End Build Meetstaat Details ---

            // --- Build Lastenboek Details String ---
            let lastenboekDetailsHtml = '';
            if (item.lastenboek_toc_entry_present && lastenboekInfo) {
              const tocTitle = lastenboekInfo.title || 'N/A';
              const pageRange = `Pagina's ${lastenboekInfo.start}-${lastenboekInfo.end}`;
              lastenboekDetailsHtml = `<p><strong class="font-medium text-gray-700">Lastenboek TOC:</strong> ${tocTitle} (${pageRange})</p>`;
            }
            // --- End Build Lastenboek Details ---

            listHtml += `
              <div class="border-b border-gray-200 pb-3 mb-3">
                <p class="font-semibold text-gray-800 mb-1">Code: ${code}</p>
                ${meetstaatDetailsHtml}
                ${lastenboekDetailsHtml}
                <p class="mt-1 text-xs text-gray-500 italic">Vergelijking: ${comparisonResult}</p>
              </div>
            `;
          });
          listHtml += '</div>'; // Close scrollable container
          return listHtml;
        };

        // Generate HTML for each detailed section
        let detailHtml = generateItemListHtml(foundInBoth, 'Items Found in Both Meetstaat and Lastenboek TOC');
        detailHtml += generateItemListHtml(onlyInMeetstaat, 'Items Found Only in Meetstaat');
        detailHtml += generateItemListHtml(onlyInTOC, 'Items Found Only in Lastenboek TOC');

        // Append the detailed lists to the results area
        // Use insertAdjacentHTML to add after the summary/errors/files info
        resultsArea.insertAdjacentHTML('beforeend', detailHtml);

        // Show action buttons if analysis was successful and has data
        if (combinedData.length > 0) {
            exportButton.classList.remove('hidden');
            discrepancyButton.classList.remove('hidden');
            // Keep discrepancy results area hidden until analysis is triggered
        } else {
            exportButton.classList.add('hidden');
            discrepancyButton.classList.add('hidden');
            discrepancyResultsArea.classList.add('hidden');
        }

      } catch (error) {
        console.error('Error during analysis or display:', error);
        resultsArea.innerHTML = `<p class="text-red-600 font-semibold">An error occurred: ${error.message}</p>`;
        exportButton.classList.add('hidden');
        discrepancyButton.classList.add('hidden');
        discrepancyResultsArea.classList.add('hidden');
      } finally {
        // Re-enable button
        analyzeButton.disabled = false;
        analyzeButton.textContent = 'Analyze';
      }
    });

    // --- Add event listener for Export Button ---
    exportButton.addEventListener('click', () => {
        // Redirect the browser to the export endpoint
        window.location.href = '/export_json';
    });

    // --- Add event listener for Discrepancy Analysis Button ---
    discrepancyButton.addEventListener('click', async () => {
        discrepancyResultsArea.classList.remove('hidden'); // Show the results area
        discrepancyResultsArea.innerHTML = '<p class="text-blue-600 font-semibold">Starting discrepancy analysis with Gemini... Please wait (this may take a while).</p>';
        discrepancyButton.disabled = true;
        discrepancyButton.textContent = 'Analyzing...';

        try {
            const response = await fetch('/start_discrepancy_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // No body needed, data is in session
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: "Unknown error during discrepancy analysis." }));
                throw new Error(`HTTP error ${response.status}: ${errorData.error || response.statusText}`);
            }

            const result = await response.json();

            if (result.error) {
                throw new Error(`Backend error: ${result.error}`);
            }

            // --- Display Discrepancy Results ---
            let discrepancyHtml = `
              <h3 class="font-semibold mb-2">Analysis Status:</h3>
              <p class="mb-4">${result.message || 'Analysis complete.'}</p>
              <h3 class="font-semibold mb-2 mt-4">Discrepancy Findings (for items in both sources):</h3>
            `;

            const analysisOutput = result.analysis_output || [];
            const analyzedItems = analysisOutput.filter(item => item.source === 'both');

            if (analyzedItems.length === 0) {
                discrepancyHtml += '<p class="text-sm text-gray-500 italic">No items found in both sources to analyze.</p>';
            } else {
                 discrepancyHtml += '<div class="space-y-3 text-sm max-h-96 overflow-y-auto border rounded p-3 bg-gray-100">'; // Scrollable container
                 analyzedItems.forEach(item => {
                    // Check for error cases first
                    if (item.error || (item.llm_discrepancy_analysis && item.llm_discrepancy_analysis.toLowerCase().startsWith('error:'))) {
                        const errorText = item.error || item.llm_discrepancy_analysis || 'Unknown error occurred';
                        discrepancyHtml += `
                            <div class="border-b border-gray-200 pb-3 mb-3 p-2 rounded bg-red-50">
                                <p class="font-semibold text-gray-800 mb-1">Code: ${item.item_code}</p>
                                <p class="text-red-600">${errorText}</p>
                            </div>
                        `;
                        return; // Skip to next item
                    }

                    // Parse the structured response
                    let analysisData;
                    try {
                        // Handle both string format and already parsed format
                        if (typeof item.llm_discrepancy_analysis === 'string') {
                            // Try to parse if it's a JSON string
                            if (item.llm_discrepancy_analysis.trim().startsWith('{')) {
                                analysisData = JSON.parse(item.llm_discrepancy_analysis);
                            } else {
                                // Legacy format - simple text
                                const isSignificant = item.llm_discrepancy_analysis.endsWith('Significant discrepancy.');
                                discrepancyHtml += `
                                    <div class="border-b border-gray-200 pb-3 mb-3 p-2 rounded ${isSignificant ? 'bg-red-100' : 'bg-gray-100'}">
                                        <p class="font-semibold text-gray-800 mb-1">Code: ${item.item_code}</p>
                                        <p class="${isSignificant ? 'text-red-800 font-medium' : 'text-gray-700'}">${item.llm_discrepancy_analysis}</p>
                                    </div>
                                `;
                                return; // Skip to next item
                            }
                        } else {
                            // Already parsed as object
                            analysisData = item.llm_discrepancy_analysis;
                        }
                        
                        // Only proceed if we actually have a checks object
                        if (!analysisData || !analysisData.checks) {
                            throw new Error("Missing checks data");
                        }
                        
                        // Determine if this item has any significant issues
                        const hasSignificantIssue = analysisData.has_significant_issue || 
                            (analysisData.checks.consistency && analysisData.checks.consistency.significant) ||
                            (analysisData.checks.location && analysisData.checks.location.significant);
                        
                        // Start building the item card
                        discrepancyHtml += `
                            <div class="border-b border-gray-200 pb-3 mb-3 p-2 rounded ${hasSignificantIssue ? 'bg-red-50 border border-red-200' : 'bg-gray-50'}">
                                <p class="font-semibold text-gray-800 mb-1 flex justify-between">
                                    <span>Code: ${item.item_code}</span>
                                    ${hasSignificantIssue ? '<span class="text-red-600 text-xs px-2 py-1 bg-red-100 rounded-full">Significant Issues</span>' : ''}
                                </p>
                        `;
                        
                        // Add summary if available
                        if (analysisData.summary) {
                            discrepancyHtml += `<p class="mb-2 ${hasSignificantIssue ? 'text-red-700 font-medium' : 'text-gray-700'}">${analysisData.summary}</p>`;
                        }
                        
                        // Add check sections with collapsible details
                        // 1. Consistency Check
                        const consistencyCheck = analysisData.checks.consistency || {};
                        discrepancyHtml += `
                            <div class="mt-2 p-1 rounded ${consistencyCheck.significant ? 'bg-red-100' : (consistencyCheck.issue_found ? 'bg-yellow-50' : 'bg-gray-100')}">
                                <p class="text-sm font-medium ${consistencyCheck.significant ? 'text-red-700' : (consistencyCheck.issue_found ? 'text-yellow-700' : 'text-gray-600')}">
                                    <span class="mr-1">üîç</span> Consistency Check: 
                                    ${consistencyCheck.issue_found ? 'Issue Found' : 'No Issues'}
                                    ${consistencyCheck.significant ? ' (Significant)' : ''}
                                </p>
                                <p class="text-xs ml-6 mt-1">${consistencyCheck.description || 'No details available'}</p>
                            </div>
                        `;
                        
                        // 2. Location Check
                        const locationCheck = analysisData.checks.location || {};
                        discrepancyHtml += `
                            <div class="mt-2 p-1 rounded ${locationCheck.significant ? 'bg-red-100' : (locationCheck.issue_found ? 'bg-yellow-50' : 'bg-gray-100')}">
                                <p class="text-sm font-medium ${locationCheck.significant ? 'text-red-700' : (locationCheck.issue_found ? 'text-yellow-700' : 'text-gray-600')}">
                                    <span class="mr-1">üìç</span> Location/Task Check: 
                                    ${locationCheck.issue_found ? 'Issue Found' : 'No Issues'}
                                    ${locationCheck.significant ? ' (Significant)' : ''}
                                </p>
                                <p class="text-xs ml-6 mt-1">${locationCheck.description || 'No details available'}</p>
                            </div>
                        `;
                        
                        // Close the item card
                        discrepancyHtml += `</div>`;
                        
                    } catch (e) {
                        // Fallback for parsing errors or unexpected formats
                        console.error('Error parsing analysis data for item', item.item_code, e);
                        discrepancyHtml += `
                            <div class="border-b border-gray-200 pb-3 mb-3 p-2 rounded bg-gray-100">
                                <p class="font-semibold text-gray-800 mb-1">Code: ${item.item_code}</p>
                                <p class="text-gray-700">${item.llm_discrepancy_analysis || 'Analysis data format error'}</p>
                            </div>
                        `;
                    }
                 });
                 discrepancyHtml += '</div>'; // Close scrollable container
            }
            discrepancyResultsArea.innerHTML = discrepancyHtml;

        } catch (error) {
            console.error('Error during discrepancy analysis:', error);
            discrepancyResultsArea.innerHTML = `<p class="text-red-600 font-semibold">An error occurred during discrepancy analysis: ${error.message}</p>`;
        } finally {
            discrepancyButton.disabled = false;
            discrepancyButton.textContent = 'Analyze Discrepancies';
        }
    });
    // ---------------------------------------------------------

  </script>

</body>
</html>
