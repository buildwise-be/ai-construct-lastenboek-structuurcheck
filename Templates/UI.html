<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lastenboek Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-6">
      <h1 class="text-2xl font-bold mb-6">📄 Lastenboek Checker</h1>
      <nav class="space-y-4">
        <button class="w-full text-left font-medium hover:text-blue-600">Upload / Analyze</button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-10 overflow-auto">
      <div class="bg-white rounded-2xl shadow p-8">
        <h2 class="text-xl font-semibold mb-4">Upload Documents</h2>
        <form id="upload-form" class="space-y-4">
          <div>
            <label for="meetstaat-input" class="block text-sm font-medium text-gray-700">Meetstaat (CSV)</label>
            <input type="file" id="meetstaat-input" name="meetstaat" accept=".csv" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </div>
          <div>
            <label for="lastenboek-input" class="block text-sm font-medium text-gray-700">Lastenboek (PDF)</label>
            <input type="file" id="lastenboek-input" name="lastenboek" accept=".pdf" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </div>
          
          <!-- New Radio Buttons for TOC Type -->
          <div class="form-group">
            <label>Analysis Type:</label><br>
            <input type="radio" id="toc_type_standard" name="toc_type" value="standard" checked>
            <label for="toc_type_standard">Standard TOC Analysis (using step1_toc/chapters.json)</label><br>
            <input type="radio" id="toc_type_vision" name="toc_type" value="vision">
            <label for="toc_type_vision">Vision TOC Analysis (using latest vision_toc_*.json)</label>
          </div>
          <!-- End New Radio Buttons -->

          <button type="button" id="analyze-button" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50">Analyze</button>
        </form>
      </div>

      <!-- Placeholder for results -->
      <div class="mt-10">
        <div class="flex justify-between items-center mb-4 flex-wrap">
          <h2 class="text-xl font-semibold mb-2 md:mb-0">Analysis Results</h2>
          <div class="flex items-center space-x-2 flex-wrap">
            <div class="mb-2 md:mb-0">
              <label for="model-select" class="text-xs font-medium text-gray-600 mr-1">Model:</label>
              <select id="model-select" name="model_select" class="text-xs border border-gray-300 rounded p-1">
                <option value="gemini-1.5-pro-002" selected>Gemini 1.5 Pro</option>
                <option value="gemini-2.0-flash-001">Gemini 2.0 Flash</option>
              </select>
            </div>
            <button id="discrepancy-button" class="hidden bg-yellow-500 text-white px-4 py-2 rounded text-sm hover:bg-yellow-600 disabled:opacity-50">Analyze Consistency</button>
            <button id="placement-button" class="hidden bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 disabled:opacity-50">Run Task Placement Check</button>
            <button id="export-button" class="hidden bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">Export Initial JSON</button>
            <button id="export-discrepancy-button" class="hidden bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">Export Discrepancy JSON</button>
          </div>
        </div>
        <div id="results-area" class="bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 min-h-[100px]">
          <p class="text-gray-500 italic">Initial results will appear here...</p>
        </div>
      </div>

      <!-- Placeholder for Discrepancy Analysis Results -->
      <div class="mt-10">
        <h2 class="text-xl font-semibold mb-4">Discrepancy Analysis</h2>
        <div id="discrepancy-results-area" class="hidden bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 min-h-[100px]">
          <p class="text-gray-500 italic">Click 'Analyze Consistency' above to start...</p>
        </div>
      </div>

    </main>
  </div>

  <!-- Add JavaScript block -->
  <script>
    const form = document.getElementById('upload-form');
    const meetstaatInput = document.getElementById('meetstaat-input');
    const lastenboekInput = document.getElementById('lastenboek-input');
    const analyzeButton = document.getElementById('analyze-button');
    const resultsArea = document.getElementById('results-area');
    const exportButton = document.getElementById('export-button');
    const discrepancyButton = document.getElementById('discrepancy-button');
    const discrepancyResultsArea = document.getElementById('discrepancy-results-area');
    const exportDiscrepancyButton = document.getElementById('export-discrepancy-button');
    const placementButton = document.getElementById('placement-button');
    const modelSelect = document.getElementById('model-select');

    analyzeButton.addEventListener('click', async () => {
      // Get the files
      const meetstaatFile = meetstaatInput.files[0];
      const lastenboekFile = lastenboekInput.files[0];

      // Basic validation
      if (!lastenboekFile) {
        alert('Please select a Lastenboek (PDF) file.');
        return;
      }
      // You might want to add validation for meetstaat if it becomes mandatory

      // Prepare form data to send
      const formData = new FormData();
      if (meetstaatFile) {
        formData.append('meetstaat', meetstaatFile);
      }
      formData.append('lastenboek', lastenboekFile);
      
      // Add the selected TOC type
      const selectedTocType = document.querySelector('input[name="toc_type"]:checked').value;
      formData.append('toc_type', selectedTocType);

      // Show loading state
      resultsArea.innerHTML = '<p class="text-blue-600 font-semibold">Analyzing documents... Please wait.</p>';
      analyzeButton.disabled = true;
      analyzeButton.textContent = 'Analyzing...';

      try {
        // Send data to the backend /analyze endpoint
        const response = await fetch('/analyze', {
          method: 'POST', // Use POST to send file data
          body: formData, // Send FormData directly
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Get the JSON result from the backend
        const result = await response.json();

        // Check for backend errors first
        if (result.error) {
          exportButton.classList.add('hidden');
          discrepancyButton.classList.add('hidden');
          placementButton.classList.add('hidden');
          discrepancyResultsArea.classList.add('hidden');
          exportDiscrepancyButton.classList.add('hidden');
          throw new Error(`Backend error: ${result.error}`);
        }

        // --- Process and Display Initial Results ---
        let initialHtml = `
          <h3 class="font-semibold mb-2">Backend Message:</h3>
          <p class="mb-4">${result.message || 'Processing complete.'}</p>
        `;

        // Display Summary if available
        if (result.analysis_summary) {
            const summary = result.analysis_summary;
            initialHtml += `
                <h3 class="font-semibold mb-2 mt-4">Summary Counts:</h3>
                <p class="text-sm mb-4 border-b pb-4">
                    <span class="mr-4"><strong class="font-medium">In Both:</strong> ${summary.count_both || 0}</span>
                    <span class="mr-4"><strong class="font-medium">Only Meetstaat:</strong> ${summary.count_meetstaat_only || 0}</span>
                    <span><strong class="font-medium">Only Lastenboek:</strong> ${summary.count_lastenboek_only || 0}</span>
                </p>
            `;
        }

        // Display Processing Errors if any
        if (result.errors && result.errors.length > 0) {
          initialHtml += `
            <h3 class="font-semibold mb-2 text-red-600">Processing Errors:</h3>
            <ul class="list-disc list-inside mb-4 text-red-500">
              ${result.errors.map(e => `<li>${e}</li>`).join('')}
            </ul>
          `;
        }

        // Display Files Processed
        initialHtml += `
          <h3 class="font-semibold mb-2">Files Processed:</h3>
          <ul class="list-disc list-inside mb-4">
            <li>Meetstaat: ${result.meetstaat_filename}</li>
            <li>Lastenboek: ${result.lastenboek_filename}</li>
            <li>TOC Type: ${result.toc_type} (${result.toc_path})</li>
          </ul>
        `;

        // Filter the combined data
        const combinedData = result.analysis_output || [];
        const foundInBoth = combinedData.filter(item => item.meetstaat_present && item.lastenboek_toc_entry_present);
        const onlyInTOC = combinedData.filter(item => !item.meetstaat_present && item.lastenboek_toc_entry_present);
        const onlyInMeetstaat = combinedData.filter(item => item.meetstaat_present && !item.lastenboek_toc_entry_present);

        // Update the results area with initial info + summary
        resultsArea.innerHTML = initialHtml;

        // Create the results table (if not already using updateTableWithResults)
        updateTableWithResults(combinedData, 'initial-results-table'); // Generate initial table

        // Show the appropriate buttons after initial analysis
            exportButton.classList.remove('hidden');
        // Show consistency button only if meetstaat was provided
        if (meetstaatInput.files[0]) {
            discrepancyButton.classList.remove('hidden');
        } else {
            discrepancyButton.classList.add('hidden');
        }
        // Show placement button only if TOC type is 'vision' (implies summaries)
        if (selectedTocType === 'vision') {
             placementButton.classList.remove('hidden');
        } else {
             placementButton.classList.add('hidden');
        }
        discrepancyResultsArea.innerHTML = '<p class="text-gray-500 italic">Select an analysis type above to begin...</p>'; // Clear previous results
        discrepancyResultsArea.classList.add('hidden'); // Ensure it's hidden
        exportDiscrepancyButton.classList.add('hidden'); // Hide export until discrepancy run

        // --- END Initial Results Display ---

      } catch (error) {
        console.error('Error during analysis:', error);
        resultsArea.innerHTML = `<p class="text-red-600 font-semibold">Error: ${error.message || 'Could not complete analysis.'}</p>`;
        exportButton.classList.add('hidden');
        discrepancyButton.classList.add('hidden');
        placementButton.classList.add('hidden'); // Also hide on error
        discrepancyResultsArea.classList.add('hidden');
        exportDiscrepancyButton.classList.add('hidden');
      } finally {
        // Re-enable button
        analyzeButton.disabled = false;
        analyzeButton.textContent = 'Analyze';
      }
    });

    // --- Discrepancy Analysis (Consistency Check) Event Listener ---
    discrepancyButton.addEventListener('click', () => {
      // Add 'disabled' state while running
      discrepancyButton.disabled = true;
      placementButton.disabled = true; // Disable other button too
      discrepancyButton.textContent = 'Analyzing...';
      // Call a function to handle the secondary analysis request
      runSecondaryAnalysis('consistency');
    });

    // --- NEW Task Placement Analysis Event Listener ---
    placementButton.addEventListener('click', () => {
        // Add 'disabled' state while running
        placementButton.disabled = true;
        discrepancyButton.disabled = true; // Disable other button too
        placementButton.textContent = 'Analyzing...';
        // Call the function to handle the secondary analysis request
        runSecondaryAnalysis('task_placement');
    });


    // --- Function to Handle Secondary Analysis (Consistency or Placement) ---
    async function runSecondaryAnalysis(analysisType) {
        // Determine which button to update based on type
        const currentButton = (analysisType === 'consistency') ? discrepancyButton : placementButton;
        const modelSelect = document.getElementById('model-select'); // Get model select element

        // Clear previous discrepancy results and show loading
        discrepancyResultsArea.innerHTML = `<p class="text-blue-600 font-semibold">Running ${analysisType.replace('_', ' ')} analysis using ${modelSelect.options[modelSelect.selectedIndex].text}... Please wait.</p>`; // Show selected model
        discrepancyResultsArea.classList.remove('hidden');
        exportDiscrepancyButton.classList.add('hidden'); // Hide export button during analysis
        // Disable model select during analysis
        modelSelect.disabled = true;

        try {
            // Get selected item codes (optional, if you add checkboxes)
            const selectedCodes = []; // Example: Get selected codes from checkboxes if implemented
            // If no codes selected, backend analyzes all applicable items
            
            const selectedModel = modelSelect.value; // Get the selected model value

            // Send request to backend
            const response = await fetch('/start_discrepancy_analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selected_codes: selectedCodes,
                    analysis_type: analysisType, // Pass the type
                    model_name: selectedModel // Pass the selected model
                }),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `HTTP error! status: ${response.status}` }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (!result.success || result.error) {
                 throw new Error(result.error || result.message || 'Analysis failed on the server.');
            }

            // --- Display Discrepancy/Placement Results ---
             discrepancyResultsArea.innerHTML = `
                <h3 class="font-semibold mb-2">${analysisType.replace('_', ' ').toUpperCase()} Analysis Results:</h3>
              <p class="mb-4">${result.message || 'Analysis complete.'}</p>
            `;

            // Check if results exist and update the table
            if (result.analysis_output && result.analysis_output.length > 0) {
                 updateTableWithResults(result.analysis_output, 'discrepancy-results-table', true); // Use table update function
                 exportDiscrepancyButton.classList.remove('hidden'); // Show export button
            } else {
                 discrepancyResultsArea.innerHTML += '<p class="text-gray-500 italic">No items were processed or returned by the LLM.</p>';
                 exportDiscrepancyButton.classList.add('hidden');
            }
             // --- End Display Results ---

        } catch (error) {
            console.error(`Error during ${analysisType} analysis:`, error);
            discrepancyResultsArea.innerHTML = `<p class="text-red-600 font-semibold">Error during ${analysisType.replace('_', ' ')} analysis: ${error.message || 'Could not complete analysis.'}</p>`;
            exportDiscrepancyButton.classList.add('hidden');
        } finally {
            // Re-enable buttons
            currentButton.disabled = false;
            currentButton.textContent = (analysisType === 'consistency') ? 'Analyze Consistency' : 'Run Task Placement Check';
             // Re-enable the other button too, if it exists and wasn't the one clicked
             if (analysisType === 'consistency' && placementButton) placementButton.disabled = false;
             if (analysisType === 'task_placement' && discrepancyButton) discrepancyButton.disabled = false;
             // Re-enable model select
             modelSelect.disabled = false;
        }
    }


    // --- Function to Update Table (Initial or Discrepancy) ---
    function updateTableWithResults(data, tableId, isDiscrepancyAnalysis = false) {
        let tableHtml = `
            <div class="overflow-x-auto">
             <table id="${tableId}" class="min-w-full divide-y divide-gray-200 shadow border border-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meetstaat Details</th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lastenboek TOC Details</th>
                        ${isDiscrepancyAnalysis ? '<th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LLM Analysis</th>' : ''}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        if (!data || data.length === 0) {
            tableHtml += '<tr><td colspan="4" class="px-4 py-3 text-sm text-gray-500 italic text-center">No data available.</td></tr>';
        } else {
            data.forEach(item => {
                const code = item.item_code || 'N/A';

                // --- Meetstaat Info ---
                let meetstaatHtml = '<td class="px-4 py-3 whitespace-normal align-top text-sm text-gray-500">'; // Use normal whitespace
                if (item.meetstaat_present && item.meetstaat_info) {
                    const mInfo = item.meetstaat_info;
                    const description = mInfo.Description || 'N/A';
                    const quantity = mInfo.Quantity !== undefined && mInfo.Quantity !== null ? mInfo.Quantity : 'N/A';
                    const unit = mInfo.Unit || '';
                    const type = mInfo.Type || ''; // Contains expanded text
                    const notes = mInfo.Notes || '';
                    meetstaatHtml += `
                        <p class="font-medium text-gray-900">${description}</p>
                        <p class="text-xs text-gray-600 mt-1">Qty: ${quantity} ${unit} (${type}) ${notes ? `- ${notes}` : ''}</p>
                    `;
                } else {
                    meetstaatHtml += '<span class="italic text-gray-400">N/A</span>';
                }
                meetstaatHtml += '</td>';

                // --- Lastenboek Info ---
                let lastenboekHtml = '<td class="px-4 py-3 whitespace-normal align-top text-sm text-gray-500">'; // Use normal whitespace
                if (item.lastenboek_toc_entry_present && item.lastenboek_page_range) {
                    const lInfo = item.lastenboek_page_range;
                    const title = lInfo.title || 'N/A';
                    const pageRange = `P. ${lInfo.start || '?'}-${lInfo.end || '?'}`;
                    const summary = lInfo.summary || ''; // Get summary if available
                    lastenboekHtml += `
                        <p class="font-medium text-gray-900">${title} <span class="text-xs">(${pageRange})</span></p>
                        ${summary ? `<p class="text-xs text-gray-600 mt-1 italic">Summary: ${summary.substring(0, 150)}...</p>` : ''}
                    `;
                } else {
                    lastenboekHtml += '<span class="italic text-gray-400">N/A</span>';
                }
                lastenboekHtml += '</td>';

                // --- LLM Analysis Info (Only if isDiscrepancyAnalysis is true) ---
                let llmHtml = '';
                if (isDiscrepancyAnalysis) {
                    llmHtml = '<td class="px-4 py-3 whitespace-normal align-top text-sm text-gray-500">'; // Use normal whitespace
                    const analysis = item.llm_discrepancy_analysis; // Use the correct key
                    if (analysis) {
                         if (analysis.error) {
                             llmHtml += `<span class="text-red-600 font-semibold">Error:</span> <span class="text-xs">${analysis.error}</span>`;
                         } else {
                             const checks = analysis.checks || {};
                             // Display result from either 'consistency' or 'task_placement' check
                             const checkResult = checks.consistency || checks.task_placement; 
                             
                             if (checkResult) {
                                 const issueFound = checkResult.issue_found;
                                 const description = checkResult.description || 'No description.';
                                 const significant = checkResult.significant;
                                 const bgColor = issueFound ? (significant ? 'bg-red-100' : 'bg-yellow-100') : 'bg-green-100';
                                 const icon = issueFound ? (significant ? '❗️' : '⚠️') : '✅';
                                 
                                 llmHtml += `
                                     <div class="p-2 rounded ${bgColor}">
                                        <p class="font-medium text-gray-900">${icon} ${issueFound ? (significant ? 'Significant Issue Found' : 'Potential Issue Found') : 'No Issue Found'}</p>
                                        <p class="text-xs text-gray-700 mt-1">${description}</p>
                                        ${analysis.summary ? `<p class="text-xs italic text-gray-500 mt-1">LLM Summary: ${analysis.summary}</p>` : ''}
                                    </div>
                                `;
                             } else {
                                llmHtml += '<span class="italic text-gray-400">Analysis structure unexpected.</span>';
                             }
                            }
                        } else {
                         llmHtml += '<span class="italic text-gray-400">Pending / Not Analyzed</span>';
                    }
                    llmHtml += '</td>';
                }


                // --- Table Row ---
                tableHtml += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap align-top text-sm font-medium text-gray-900">${code}</td>
                        ${meetstaatHtml}
                        ${lastenboekHtml}
                        ${llmHtml}
                    </tr>
                `;
            });
        }

        tableHtml += `
                </tbody>
             </table>
                            </div>
                        `;
                        
        // Place the table in the correct area
        if (isDiscrepancyAnalysis) {
             // Prepend the table to the discrepancy area (keeps messages visible above)
             discrepancyResultsArea.insertAdjacentHTML('beforeend', tableHtml);
            } else {
             // Replace content of initial results area
             resultsArea.innerHTML += tableHtml; // Append table after summary info
        }
    }


    // --- Export Button Event Listener (Initial Analysis) ---
    exportButton.addEventListener('click', () => {
        // Redirect the browser to the export endpoint
        window.location.href = '/export_json';
    });

    // --- Export Discrepancy Button Event Listener --- 
    exportDiscrepancyButton.addEventListener('click', () => {
        window.location.href = '/export_discrepancy_json';
    });

  </script>

</body>
</html>
