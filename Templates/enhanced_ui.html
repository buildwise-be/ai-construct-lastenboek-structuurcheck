<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enhanced Placement Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .issue-card {
            border-left: 4px solid;
            transition: all 0.3s ease-in-out;
        }
        .issue-high { border-color: #ef4444; } /* red-500 */
        .issue-medium { border-color: #f97316; } /* orange-500 */
        .issue-low { border-color: #eab308; } /* yellow-500 */

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #374151;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .filter-btn:hover {
            background-color: #f3f4f6;
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md p-6 flex flex-col">
            <div>
                <h1 class="text-2xl font-bold mb-6 text-[#0087b7]">Enhanced Placement Checker</h1>
                <nav class="space-y-4">
                    <button class="w-full text-left font-medium hover:text-blue-600">Analysis</button>
                </nav>
            </div>
            <div class="mt-auto">
                <img src="/static/logo/BWlogo.png" alt="Buildwise Logo" class="h-16 mx-auto mb-4">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-10 overflow-auto">
            <div class="bg-white rounded-2xl shadow p-8">
                <h2 class="text-xl font-semibold mb-4">Run Analysis</h2>
                <p class="text-gray-600 mb-4">
                    This tool analyzes the placement of tasks within the document structure based on the full text of each section. It uses the latest processed OCR output file found on the server.
                </p>
                <form id="analysis-form" class="space-y-4">
                    <div>
                        <label for="analysis-file-select" class="block text-sm font-medium text-gray-700">Select Analysis File:</label>
                        <select id="analysis-file-select" name="analysis_file" class="mt-1 block w-full border border-gray-300 rounded p-2">
                            <option>Loading files...</option>
                        </select>
                    </div>
                    <input type="hidden" name="toc_type" value="enhanced">
                    <button type="button" id="analyze-button" class="bg-[#0087b7] text-white px-4 py-2 rounded hover:bg-[#00739e] disabled:opacity-50">
                        Run Enhanced Placement Check
                    </button>
                </form>
            </div>

            <!-- Results Area -->
            <div class="mt-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Analysis Results</h2>
                    <button id="export-button" class="hidden bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
                        Export Full JSON
                    </button>
                </div>
                <!-- Summary Dashboard -->
                <div id="summary-dashboard" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-blue-100 border border-blue-200 p-4 rounded-lg text-center">
                        <h4 classs="text-lg font-semibold text-blue-800">Total Sections</h4>
                        <p id="total-sections" class="text-2xl font-bold text-blue-900">0</p>
                    </div>
                    <div class="bg-red-100 border border-red-200 p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold text-red-800">High Severity</h4>
                        <p id="high-severity" class="text-2xl font-bold text-red-900">0</p>
                    </div>
                    <div class="bg-orange-100 border border-orange-200 p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold text-orange-800">Medium Severity</h4>
                        <p id="medium-severity" class="text-2xl font-bold text-orange-900">0</p>
                    </div>
                    <div class="bg-yellow-100 border border-yellow-200 p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold text-yellow-800">Low Severity</h4>
                        <p id="low-severity" class="text-2xl font-bold text-yellow-900">0</p>
                    </div>
                </div>
                <div id="results-area" class="bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 min-h-[100px]">
                    <p class="text-gray-500 italic">Results will appear here after running the analysis.</p>
                </div>
            </div>
            
            <!-- Filter buttons will be dynamically added here -->
            <div id="filter-controls" class="my-4">
                <span class="text-sm font-medium text-gray-700 mr-2">Filter by severity:</span>
                <button class="filter-btn active" data-severity="all">All</button>
                <button class="filter-btn" data-severity="high">High</button>
                <button class="filter-btn" data-severity="medium">Medium</button>
                <button class="filter-btn" data-severity="low">Low</button>
            </div>

        </main>
    </div>

    <script>
        const analyzeButton = document.getElementById('analyze-button');
        const resultsArea = document.getElementById('results-area');
        const exportButton = document.getElementById('export-button');
        const fileSelect = document.getElementById('analysis-file-select');

        // --- New: Load files on page load ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/get_analysis_files');
                const files = await response.json();
                
                if (response.ok) {
                    fileSelect.innerHTML = ''; // Clear "Loading..."
                    if (files.length > 0) {
                        files.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file;
                            option.textContent = file;
                            fileSelect.appendChild(option);
                        });
                    } else {
                        fileSelect.innerHTML = '<option>No analysis files found</option>';
                        analyzeButton.disabled = true;
                    }
                } else {
                    throw new Error(files.error || 'Failed to load files.');
                }
            } catch (error) {
                console.error('Error loading analysis files:', error);
                fileSelect.innerHTML = `<option>Error: ${error.message}</option>`;
                analyzeButton.disabled = true;
            }
        });
        // --- End New ---

        analyzeButton.addEventListener('click', async () => {
            resultsArea.innerHTML = '<p class="text-blue-600 font-semibold">Analyzing... This may take a few moments.</p>';
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analyzing...';
            exportButton.classList.add('hidden');

            try {
                // Step 1: Start the analysis
                const analyzeResponse = await fetch('/analyze', {
                    method: 'POST',
                    body: new FormData(document.getElementById('analysis-form'))
                });

                const analyzeResult = await analyzeResponse.json();

                if (!analyzeResponse.ok || analyzeResult.error) {
                    throw new Error(analyzeResult.error || `HTTP error! status: ${analyzeResponse.status}`);
                }

                resultsArea.innerHTML = `<p class="text-green-600 font-semibold">${analyzeResult.message}. Fetching detailed results...</p>`;

                // Step 2: Fetch the detailed results
                const resultsResponse = await fetch('/get_enhanced_results');
                const resultsData = await resultsResponse.json();

                if (!resultsResponse.ok || resultsData.error) {
                    throw new Error(resultsData.error || 'Failed to fetch detailed results.');
                }
                
                displayResults(resultsData);
                exportButton.classList.remove('hidden');

            } catch (error) {
                console.error('Error during analysis:', error);
                resultsArea.innerHTML = `<p class="text-red-600 font-semibold">Error: ${error.message}</p>`;
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Run Enhanced Placement Check';
            }
        });
        
        exportButton.addEventListener('click', () => {
            window.location.href = '/export_enhanced_json';
        });

        function displayResults(data) {
            if (!Array.isArray(data)) {
                resultsArea.innerHTML = '<p class="text-red-600">Error: Invalid data format received from server.</p>';
                return;
            }

            // --- Summary Calculation ---
            let totalSections = data.length;
            let highSeverity = 0;
            let mediumSeverity = 0;
            let lowSeverity = 0;

            data.forEach(chapter => {
                const issues = chapter.analysis ? chapter.analysis.issues_found : [];
                if (Array.isArray(issues)) {
                    issues.forEach(issue => {
                        const severity = (issue.severity || 'medium').toLowerCase();
                        if (severity === 'high') highSeverity++;
                        else if (severity === 'medium') mediumSeverity++;
                        else if (severity === 'low') lowSeverity++;
                    });
                }
            });

            // --- Update and Show Dashboard ---
            document.getElementById('total-sections').textContent = totalSections;
            document.getElementById('high-severity').textContent = highSeverity;
            document.getElementById('medium-severity').textContent = mediumSeverity;
            document.getElementById('low-severity').textContent = lowSeverity;
            document.getElementById('summary-dashboard').classList.remove('hidden');
            // -----------------------------

            let html = '';
            let totalIssues = 0;

            if (data.length === 0) {
                resultsArea.innerHTML = '<p class="text-gray-500">The analysis ran successfully, but no sections were returned to display.</p>';
                return;
            }

            data.forEach(chapter => {
                const issues = chapter.analysis ? chapter.analysis.issues_found : [];
                const hasIssues = Array.isArray(issues) && issues.length > 0;
                totalIssues += issues.length;

                const borderColor = hasIssues ? 'border-red-200' : 'border-green-200';
                const textColor = hasIssues ? 'text-red-800' : 'text-green-800';
                const issueCountBadge = hasIssues ? `<span class="ml-2 text-xs font-semibold ${textColor} bg-opacity-20 rounded-full px-2 py-1">${issues.length} issue(s)</span>` : '';

                html += `
                    <div class="border ${borderColor} rounded-md my-2">
                        <div class="p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 flex justify-between items-center" onclick="toggleCollapse('content-${chapter.chapter.replace(/\./g, '-')}')">
                            <h3 class="font-bold text-lg text-gray-800">${chapter.chapter} - ${chapter.title || 'No Title'} ${issueCountBadge}</h3>
                            <span class="text-gray-500 text-sm">Pages: ${chapter.start_page}-${chapter.end_page}</span>
                        </div>
                        <div id="content-${chapter.chapter.replace(/\./g, '-')}" class="p-4 border-t ${borderColor} hidden">
                `;
                
                if (hasIssues) {
                    issues.forEach(issue => {
                        const severity = issue.severity || 'medium'; // Default severity
                        const severityClass = `issue-${severity.toLowerCase()}`;
                        html += `
                            <div class="issue-card ${severityClass}" data-severity="${severity.toLowerCase()}" style="display: block;">
                                <div class="p-3 my-2 rounded-md border bg-gray-50">
                                    <p class="font-semibold text-gray-900">${issue.description}</p>
                                    <div class="mt-2 text-xs font-medium">
                                        <span class="inline-block bg-gray-200 text-gray-800 rounded-full px-2 py-1">Severity: ${severity}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p class="text-green-700 font-medium">No issues found in this section.</p>`;
                }

                html += `</div></div>`;
            });

            resultsArea.innerHTML = html;
            // summary.innerHTML = `<strong>Analysis complete. Found ${totalIssues} total issues across ${data.length} sections.</strong>`; // summary is not defined in this file
            // resultsContainer.classList.remove('hidden'); // resultsContainer is not defined in this file
            
            // Re-add event listeners to the new buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterResults(this.dataset.severity);
                });
            });
        }

        function toggleCollapse(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.toggle('hidden');
            }
        }

        function filterResults(severity) {
            document.querySelectorAll('.issue-card').forEach(card => {
                const cardSeverity = card.dataset.severity;
                if (severity === 'all' || cardSeverity === severity) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html> 